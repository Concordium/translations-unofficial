
.. _networkDashboardLink: https://dashboard.testnet.concordium.com/
.. _node-dashboard: http://localhost:8099
.. _Discord: https://discord.com/invite/xWmQ5tp

.. _become-a-baker:

==================================
Начинаем майнить (создавать блоки)
==================================

.. contents::
   :local:
   :backlinks: none

В этом разделе объясняется, кто такой майнер, какова его роль в сети и как им стать.

После прочтения раздела вы узнаете о том:

кто такой майнер, какие понятия с ним связаны
как усовершенствовать ваш узел, чтобы стать майнером

-  Кто такой майнер, какие понятия с ним связаны.
-  Как усовершенствовать ваш узел, чтобы стать майнером.

Для того, чтобы стать майнером, необходимо осуществить следующие шаги:

#. Создать счет с некоторым количеством GTU на нем.
#. Получить набор ключей для майнинга.
#. Зарегистрировать ключи для майнинга в аккаунте.
#. Запустить работу узла с помощью ключей для майнинга.

В результате осуществления этих шагов узел майнера сможет генерировать блоки.
Когда сгенерированный блок добавляется в сеть, майнер получает вознаграждение.

.. note::

   В данном разделе мы будем употреблять наименование ``bakerAccount`` для названия аккаунта,
   который будет использоваться при создании и регистрации майнера.

Определения
===========

Майнер
-----

Узел становится *майнером*, когда он участвует в сети создавая новые блоки,
которые добавляются в сеть. Майнер собирает, заказывает и проверяет транзакции,
которые включены в блок, чтобы поддерживать целостность блокчейна. Майнер подписывает
каждый блок для того, чтобы он мог быть проверен и использован остальными участниками сети.

Ключи майнера
----------

У каждого майнера есть набор криптографических ключей, которые называются ключи майнера.
Узел использует эти ключи для того, чтобы подписать блоки, которые он генерирует. Для того,
чтобы сгенерировать блоки, подписанные определенным майнером, необходимо, чтобы узел был
запущен с помощью загруженных ключей майнера.

Счета/аккаунт для майнинга
-------------

Каждый аккаунт может использовать набор ключей для того, чтобы зарегистрировать майнера.

Каждый раз, когда майнер генерирует актуальный блок, который включается в сеть,
через некоторое время ему на счет приходит вознаграждение.

Ставка и лотерея
-----------------

.. todo::

   - Link to release schedule.

Часть средств своего GTU-баланса майнер может сделать *ставкой майнера*,
а позже вручную снять ограничения со всей или части поставленной суммы.
Сумма ставки не может быть перемещена или переведена до тех пор пока майнер не снимет с нее ограничения.

.. note::

   Если на счете есть средства, которые были переведены с графиком разблокирования,
   они могут быть использованы для ставки, даже если они еще не разблокированы.

Для того, чтобы быть выбранным для генерации блока, майнер должен принять участие в *лотерее*,
в которой шансы получить выигрышный билет приблизительно пропорциональны поставленной сумме.

Та же ставка используется при принятии решения о включении или невключении майнера в комитет
финализации. См. `Финализация`_.

.. _epochs-and-slots:

Эпохи и слоты
----------------

В блокчейне Concordium время разделено на *слоты*. Слоты имеют свою длительность,
зафиксированную в блоке Genesis. В любой отдельно взятой ветке каждый слот может
иметь не более одного блока, но несколько блоков в разных ветвях могут быть созданы
в одном и том же слоте.


.. todo::

   Let's add a picture.

Говоря о вознаграждении и других связанных с майнингом процессах, мы используем концепцию
эпохи. Под ней мы понимаем единицу времени, которая определяет период, в котором зафиксированы
конкретные майнеры и ставки. Эпохи имеют определенную продолжительность, закрепленную в блоке Genesis.
В нашем Тестнете эпоха имеет длительность, равную **1 часу**.

Начинаем майнить
============

Управление счетами
-----------------

В этом разделе приводится краткое описание последовательности шагов по импорту аккаунта.
Более подробную инструкцию можно найти здесь :ref:`managing_accounts`.

Счета создаются при помощи приложения  :ref:`concordium_id`. Если счет уже был однажды создан,
перейдя на вкладку **More**(еще) и выбрав **Export**(экспорт) вы получаете доступ к файлу JSON,
который содержит информацию о счете.

Для того, чтобы импортировать счет в toolchain запустите

.. code-block:: console

   $concordium-client config account import <path/to/exported/file> --name bakerAccount


``concordium-client`` попросит ввести пароль, чтобы расшифровать экспортированный файл и
импортировать все счета. Для шифрования ключей подписи транзакций и расшифрованных ключей
переводов будет использоваться один и тот же пароль.

Создание ключей для майнинга и его регистрация
--------------------------------------------

.. note::

   Для того, чтобы сделать это, необходимо, чтобы у вас на счете было некоторое количество GTU,
   поэтому не забудьте пополнить счет дропом на 100 GTU в мобильном приложении.

Каждый счет имеет уникальный ID майнера, который используется, когда происходит регистрация майнера.
Этот ID генерируется сетью и в настоящее время не может быть вычислен заранее.
ID должен быть указан в файле ключей майнера его узла, что бы он мог использовать ключи майнера для
создания блоков. ``concordium-client`` автоматически заполнит поле при совершении следующих операций.

Для того, чтобы создать новый набор ключей, выполните:

.. code-block:: console

   $concordium-client baker generate-keys <keys-file>.json


Здесь вы сможете указать произвольное название для файла с ключами. Чтобы зарегистрировать ключи в сети,
вы должны :ref:`запустить узел <running-a-node>` и отправить в сеть транзакцию ``baker add``:

.. code-block:: console

   $concordium-client baker add <keys-file>.json --sender bakerAccount --stake <amountToStake> --out <concordium-data-dir>/baker-credentials.json

заменяя

- ``<amountToStake>`` на количество GTU, необходимое для первой ставки майнера
- ``<concordium-data-dir>`` на следующий каталог:

  * для Linux and MacOS: ``~/.local/share/concordium``
  * для Windows:  ``%LOCALAPPDATA%\\concordium``.

(Имя выходного файла должно остаться таким - ``baker-credentials.json``).

Укажите флаг ``--no-restake``, чтобы избежать автоматического добавления вознаграждений
к ставке майнера. Об этом можно узнать подробнее в разделе `Увеличение ставки за счет дохода`_.

Для того, чтобы запустить узел с помощью ключей майнера и начать создавать блоки, для начала вам
необходимо выключить текущий работающий узел (нажатием ``Ctrl + C`` на устройстве, на которой запущен узел,
или используя исполняемый файл ``concordium-node-stop``).

После размещения файла в соответствующем каталоге (это уже сделано в предыдущей команде, когда вы определяетесь с
выходным файлом) запустите узел снова используя ``concordium-node``. Узел автоматически начнет производить блоки,
когда майнер будет включен в число майнеров текущей эпохи.

Это изменение будет выполненно немедленно и вступит в силу, когда завершится эпоха, следующая за той,
в которой была осуществлена транзакция по включению майнера в блок.

.. table:: Хронология: добавление майнера

   +-------------------------------------------+-----------------------------------------+---------------------+
   |                                           |     Когда транзакция включена в блок    | По истечении 2 эпох |
   +===========================================+=========================================+=====================+
   | Изменение отображается при запуске узла   |  ✓                                      |                     |
   +-------------------------------------------+-----------------------------------------+---------------------+
   | Майнер включен в комитет майнеров         |                                         | ✓                   |
   +-------------------------------------------+-----------------------------------------+---------------------+

.. note::

   Если транзакция по включению майнера была включена в блок в течение эпохи `Е`, майнер будет считаться членом
   комитета майнеров, когда начнется эпоха `Е+2`.

Управление майнером
==================

Проверка статуса майнера и его лотерейного статуса
------------------------------------------------------

Для того, чтобы проверить генерирует ли узел блоки, существует несколько источников,
информация из которых отличается степенью детальности.

- В `сетевой панели инструментов <http://dashboard.testnet.concordium.com>`_,
  у вашего узла будет виден ID майнера в колонке ``Baker``.
- При помощи ``concordium-client`` вы можете проверить список активных майнеров и приблизительную сумму их ставок,
  т.е. их лотерейный статус. Лотерейный статус показывает, какова вероятность того, что конкретный майнер выиграет
  лотерею и произведет блок.

  .. code-block:: console

     $concordium-client consensus show-parameters --include-bakers
     Election nonce:      07fe0e6c73d1fff4ec8ea910ffd42eb58d5a8ecd58d9f871d8f7c71e60faf0b0
     Election difficulty: 4.0e-2
     Bakers:
                                  Account                       Lottery power
             ----------------------------------------------------------------
         ...
         34: 4p2n8QQn5akq3XqAAJt2a5CsnGhDvUon6HExd2szrfkZCTD4FX   <0.0001
         ...

- С помощью ``concordium-client`` вы можете проверить, что аккаунт зарегистрировал майнера и уточнить текущую сумму ставки этого майнера.

  .. code-block:: console

     $./concordium-client account show bakerAccount
     ...

     Baker: #22
      - Staked amount: 10.000000 GTU
      - Restake earnings: yes
     ...

- Если сумма ставки достаточно велика и узел работает с загруженными ключами майнера,
  то майнер должен генерировать блоки. В своем мобильном кошельке вы увидите, что
  вознаграждение за майнинг поступает на ваш счет, как это видно на следующем изображении:

  .. image:: images/bab-reward.png
     :align: center
     :width: 250px

Обновление суммы ставки
--------------------------

Для того, чтобы обновить сумму ставки, выполните следующее

.. code-block:: console

   $concordium-client baker update-stake --stake <newAmount> --sender bakerAccount

Изменение размера ставки влияет на вероятность того, что майнер будет выбран для генерации блоков.

Когда майнер **делает ставку впервые или увеличивает размер ставки**, эти изменения прописываются в сети
и становятся видимыми, как только транзакция включается в блок (можно посмотреть с помощью ``concordium-client account show bakerAccount``).
Действие вступает в силу через 2 эпохи после совершения.

.. table:: Хронология: увеличение ставки

   +----------------------------------------+-----------------------------------------+----------------+
   |                                        | Когда транзакция включена в блок        | Через 2 эпохи  |
   +========================================+=========================================+================+
   | Изменение видно при запросе узла       | ✓                                       |                |
   +----------------------------------------+-----------------------------------------+----------------+
   | Майнер использует новую ставку         |                                         | ✓              |
   +----------------------------------------+-----------------------------------------+----------------+

Когда майнер уменьшает ставку, для ее вступления в силу необходимо *2+ bakerCooldownEpochs* эпохи. Изменение становится видимым в сети,
когда транзакция включается в блок. Это можно отследить через ``concordium-client account show bakerAccount``

.. code-block:: console

   $concordium-client account show bakerAccount
   ...

   Baker: #22
    - Staked amount: 50.000000 GTU to be updated to 20.000000 GTU at epoch 261  (2020-12-24 12:56:26 UTC)
    - Restake earnings: yes

   ...

.. table:: Хронология: уменьшение ставки

   +----------------------------------------+-----------------------------------------+----------------------------------------+
   |                                        | Когда транзакция включена в блок        | После *2 + bakerCooldownEpochs* эпох   |
   +========================================+=========================================+========================================+
   | Изменение видно при запросе узла       | ✓                                       |                                        |
   +----------------------------------------+-----------------------------------------+----------------------------------------+
   | Майнер использует новую ставку         |                                         | ✓                                      |
   +----------------------------------------+-----------------------------------------+----------------------------------------+
   | Ставка может быть понижена снова       | ✗                                       | ✓                                      |
   | или майнер может быть удален           |                                         |                                        |
   +----------------------------------------+-----------------------------------------+----------------------------------------+

.. note::

   В Тестнете ``bakerCooldownEpochs`` изначально установлено 168 эпох.
   Этот показатель можно отследить следующим образом:

   .. code-block:: console

      $concordium-client raw GetBlockSummary
      ...
              "bakerCooldownEpochs": 168
      ...

.. warning::

   Как указано в разделе `Определения`_, размер ставки является заблокированным.
   Это означает, что она не может быть переведена или использована для оплаты.
   Вы должны помнить об этом и, рассчитывая размер ставки, исходить из того, что
   эта сумма не понадобится вам в ближайшее время. В частности, чтобы отменить
   регистрацию майнера или изменить размер ставки на вашем счете должно быть некоторое
   количество свободных GTU, суммы которых хватит для покрытия транзакционных издержек.

Увеличение ставки за счет дохода
----------------------

Когда майнер участвует в работе сети и генерирует блоки, на его счет поступает вознаграждение
за каждый произведенный блок. По умолчанию это вознаграждение автоматически добавляется к поставленной сумме.

Вы можете изменить эту настройку и получать вознаграждение на баланс общего счета, не добавляя его к ставке автоматически.
Этот параметр можно изменить с помощью ``concordium-client``:

.. code-block:: console

   $concordium-client baker update-restake False --sender bakerAccount
   $concordium-client baker update-restake True --sender bakerAccount

Изменение этой настройки начинает действовать сразу же, однако влиять на майнинг и финализацию они начинают через одну эпоху.
Текущее значение этой настройки можно увидеть в информации о счете, которую можно запросить с помощью ``concordium-client``:

.. code-block:: console

   $concordium-client account show bakerAccount
   ...

   Baker: #22
    - Staked amount: 50.000000 GTU
    - Restake earnings: yes

   ...

.. table:: Хронология: увеличения ставки за счет дохода

   +----------------------------------------------+----------------------------------+--------------------------------------+
   |                                              | Когда транзакция включена в блок | Через 2 эпохи после вознаграждения   |
   +==============================================+==================================+======================================+
   | Изменение видно при запросе узла             | ✓                                |                                      |
   +----------------------------------------------+----------------------------------+--------------------------------------+
   | Вознаграждение автоматически                 | ✓                                |                                      |
   | (не) прибавляется к размеру ставки           | ✓                                |                                      |
   +----------------------------------------------+----------------------------------+--------------------------------------+
   | При автоматическом увеличении ставки за счет |                                  | ✓                                    |
   | дохода это влияет на лотерейный статус       |                                  |                                      |
   +----------------------------------------------+----------------------------------+--------------------------------------+

Когда майнер зарегистрирован, по умолчанию все его вознаграждения будут включаться в его ставку.
Но как указано выше, вы можете изменить эту настройку, указав флаг ``--no-restake`` в разделе ``baker add``, как показано здесь:

.. code-block:: console

   $concordium-client baker add baker-keys.json --sender bakerAccount --stake <amountToStake> --out baker-credentials.json --no-restake

Финализация
------------

Финализация — это процесс голосования, который осуществляется узлами, входящими в **комитет финализации**.
Он **финализирует** блок, когда достаточно большое число членов комитета получили этот блок и одобрили его генерацию.
Более новые блоки должны иметь финализированный блок в качестве предшественника, чтобы гарантировать целостность
цепочки. Чтобы получить больше информации об этом процессе, читайте раздел :ref:`Финализация<glossary-finalization>`.

Комитет финализации формируется из майнеров с определенным размером ставок. Это означает, что для участия
в комитете финализации вам возможно будет необходимо изменить размер ставки, чтобы он достиг требуемого порога.
В Тестнете размер ставки, необходимый для участия в комитете финализации, составляет 0,1% от общей суммы существующих GTU.

Участники комитета финализации получают вознаграждение за каждый финализированный блок. Вознаграждение поступает на
счет майнера через некоторое время после финализации блока.

Удаление майнера
================

Контролирующий аккаунт может отменить регистрацию своего майнера в цепочке.
Для этого необходимо выполнить следующие действия в ``concordium-client``:

.. code-block:: console

   $concordium-client baker remove --sender bakerAccount

Это приведет к удалению майнера из списка майнеров и разблокированию поставленных средств майнера,
которые теперь могут быть свободно перемещены.

Когда вы удаляете майнера, это действие вступает в силу тогда же, как и в случае с уменьшением размера ставки.
Оно начнет действовать через *2 + bakerCooldownEpochs* эпохи. Действие отображается в цепочке, когда транзакция включается в блок.
Вы можете проверить, когда это изменение вступит в силу, запросив информацию о счете с помощью ``concordium-client`` как обычно:

.. code-block:: console

   $concordium-client account show bakerAccount
   ...

   Baker #22 to be removed at epoch 275 (2020-12-24 13:56:26 UTC)
    - Staked amount: 20.000000 GTU
    - Restake earnings: yes

   ...

.. table:: Хронология: удаление майнера

   +--------------------------------------------+-----------------------------------------+----------------------------------------+
   |                                            |     Когда транзакция включена в блок    |  После *2 + bakerCooldownEpochs* эпох  |
   +============================================+=========================================+========================================+
   | Изменение видно при запросе узла           | ✓                                       |                                        |
   +--------------------------------------------+-----------------------------------------+----------------------------------------+
   | Майнер исключается из комитета майнеров    |                                         | ✓                                      |
   +--------------------------------------------+-----------------------------------------+----------------------------------------+

.. warning::

   Действия по уменьшению размера ставки и удалению майнера не могут быть осуществлены одновременно.
   В течение the времени ожидания после уменьшения ставки майнер не может быть удален и наоборот.

Служба поддержки и обратная связь
==================

Если у вас возникли какие-либо проблемы или появились предложения, присылайте
ваши вопросы и комментарии в `Discord`_ или свяжитесь с нами через `testnet@concordium.com`_.

.. _Discord: https://discord.gg/xWmQ5tp
.. _`testnet@concordium.com`: mailto:testnet@concordium.com
